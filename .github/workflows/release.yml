name: Release

on:
  push:
    branches:
      - feat.windows.support
      - feat/whisper.migration
      - feat/vulkan-support
      - ui2
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.0.6)"
        required: true
        type: string

jobs:
  build:
    name: Build ${{ matrix.os == 'macos' && 'macOS' || 'Windows' }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: macos
            arch: arm64
            runner: macos-latest
          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: windows
            arch: x64
            runner: windows-2025

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify architecture
        if: matrix.os == 'macos'
        run: |
          CURRENT_ARCH=$(uname -m)
          echo "Current shell architecture: $CURRENT_ARCH"
          echo "Target architecture: ${{ matrix.arch }}"
          echo "Arch command output: $(arch)"

          if [[ "${{ matrix.arch }}" == "x64" ]]; then
            if [[ "$CURRENT_ARCH" != "x86_64" ]]; then
              echo "ERROR: Expected x86_64 architecture but got $CURRENT_ARCH"
              exit 1
            fi
            echo "✓ Architecture verified: Running as native x86_64 on Intel hardware"
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            if [[ "$CURRENT_ARCH" != "arm64" ]]; then
              echo "ERROR: Expected arm64 architecture but got $CURRENT_ARCH"
              exit 1
            fi
            echo "✓ Architecture verified: Running as native arm64"
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # 24.2 to at least 24.6 (atm of writing this) has issues with symlink deref in nested directories
          node-version: "24.1.0"
          cache: "pnpm"

      - name: Install Vulkan SDK
        if: matrix.os == 'windows'
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.3.290.0
          cache: true

      - name: Log Node.js architecture and platform
        run: |
          echo "=== Node.js Process Information ==="
          node -e "console.log('process.arch:', process.arch)"
          node -e "console.log('process.platform:', process.platform)"
          echo ""

      - name: Install dependencies
        env:
          GGML_NATIVE: OFF # ensure postinstall builds avoid i8mm on CI runners
        run: pnpm install --frozen-lockfile

      - name: Build whisper wrapper JS
        run: pnpm --filter @amical/whisper-wrapper build

      - name: Build whisper native binaries
        env:
          GGML_NATIVE: OFF # CI mac runners lack i8mm support; keep CPU features conservative here
        run: pnpm --filter @amical/whisper-wrapper build:native

      - name: Build whisper native binaries (vulkan)
        if: matrix.os == 'windows'
        env:
          GGML_NATIVE: OFF
        run: pnpm --filter @amical/whisper-wrapper build:native:vulkan

      - name: Download Node.js binaries
        working-directory: apps/desktop
        run: pnpm download-node

      - name: Import Developer ID cert
        if: matrix.os == 'macos'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.DEVELOPER_CERT_BASE64 }}
          p12-password: ${{ secrets.DEVELOPER_CERT_PASSPHRASE }}

      - name: List signing identities (debug)
        if: matrix.os == 'macos'
        run: security find-identity -v -p codesigning

      - name: Build artifacts (macOS)
        if: matrix.os == 'macos'
        working-directory: apps/desktop
        env:
          SKIP_CODESIGNING: false
          SKIP_NOTARIZATION: false
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CODESIGNING_IDENTITY: ${{ secrets.CODESIGNING_IDENTITY }}
          POSTHOG_HOST: https://app.posthog.com
          TELEMETRY_ENABLED: true
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          FEEDBACK_SURVEY_ID: ${{ secrets.FEEDBACK_SURVEY_ID }}
          AUTH_CLIENT_ID: ${{ secrets.AUTH_CLIENT_ID }}
          AUTHORIZATION_ENDPOINT: ${{ secrets.AUTHORIZATION_ENDPOINT }}
          AUTH_TOKEN_ENDPOINT: ${{ secrets.AUTH_TOKEN_ENDPOINT }}
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
          AUTH_REDIRECT_URI: ${{ secrets.AUTH_REDIRECT_URI }}
        run: |
          echo "Prepackaging macOS ${{ matrix.arch }} app with Forge"
          pnpm prep:mac:${{ matrix.arch }}
          echo "Building macOS ${{ matrix.arch }} installer artifacts with electron-builder"
          pnpm build:installer:mac:${{ matrix.arch }}

      - name: Normalize macOS updater metadata filename
        if: matrix.os == 'macos'
        working-directory: apps/desktop
        run: |
          if [ ! -f "out/builder/latest-mac.yml" ]; then
            echo "Expected out/builder/latest-mac.yml to exist for macOS ${{ matrix.arch }} build"
            exit 1
          fi
          mv out/builder/latest-mac.yml out/builder/latest-mac-${{ matrix.arch }}.yml

      - name: Build artifacts (Windows)
        if: matrix.os == 'windows'
        working-directory: apps/desktop
        env:
          POSTHOG_HOST: https://app.posthog.com
          TELEMETRY_ENABLED: true
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          FEEDBACK_SURVEY_ID: ${{ secrets.FEEDBACK_SURVEY_ID }}
          AUTH_CLIENT_ID: ${{ secrets.AUTH_CLIENT_ID }}
          AUTHORIZATION_ENDPOINT: ${{ secrets.AUTHORIZATION_ENDPOINT }}
          AUTH_TOKEN_ENDPOINT: ${{ secrets.AUTH_TOKEN_ENDPOINT }}
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
          AUTH_REDIRECT_URI: ${{ secrets.AUTH_REDIRECT_URI }}
        run: |
          echo "Prepackaging Windows x64 app with Forge"
          pnpm prep:win:x64
          echo "Building Windows x64 installer artifacts with electron-builder"
          pnpm build:installer:win:x64

      - name: Get version from package.json
        id: package_version
        working-directory: apps/desktop
        shell: bash
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Upload artifacts (macOS)
        if: matrix.os == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            apps/desktop/out/builder/*.dmg
            apps/desktop/out/builder/*-mac.zip
            apps/desktop/out/builder/*.yml
            apps/desktop/out/builder/*.blockmap

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: |
            apps/desktop/out/builder/*.exe
            apps/desktop/out/builder/*.yml
            apps/desktop/out/builder/*.blockmap

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: package_version
        working-directory: apps/desktop
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Full artifacts directory structure ==="
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.yml" -o -name "*.blockmap" \) | sort
          echo ""
          echo "=== Detailed file listing ==="
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.yml" -o -name "*.blockmap" \) -exec ls -la {} \;

      - name: Install yq
        run: |
          YQ_VERSION="v4.45.4"
          sudo curl -fsSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Prepare updater metadata
        id: updater_metadata
        shell: bash
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          CHANNEL="latest"
          if [[ "$VERSION" == *"-alpha"* ]]; then
            CHANNEL="alpha"
          elif [[ "$VERSION" == *"-beta"* ]]; then
            CHANNEL="beta"
          fi
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT

          mkdir -p release-assets

          # Copy signed installer artifacts and blockmaps.
          find artifacts -type f \( -name "*.dmg" -o -name "*-mac.zip" -o -name "*.exe" -o -name "*.blockmap" \) -exec cp {} release-assets/ \;

          MAC_X64_METADATA="$(find artifacts -type f -name 'latest-mac-x64.yml' | head -n 1)"
          MAC_ARM_METADATA="$(find artifacts -type f -name 'latest-mac-arm64.yml' | head -n 1)"

          if [[ -n "$MAC_X64_METADATA" && -n "$MAC_ARM_METADATA" ]]; then
            yq eval-all '
              select(fileIndex == 0) as $x64 |
              select(fileIndex == 1) as $arm |
              if (($x64.version != null and $arm.version != null) and ($x64.version != $arm.version))
              then error("Version mismatch between mac metadata files")
              else ($x64 | .files = (($x64.files // []) + ($arm.files // [])))
              end
            ' "$MAC_X64_METADATA" "$MAC_ARM_METADATA" > release-assets/latest-mac.yml
          elif [[ -n "$MAC_X64_METADATA" ]]; then
            cp "$MAC_X64_METADATA" release-assets/latest-mac.yml
          elif [[ -n "$MAC_ARM_METADATA" ]]; then
            cp "$MAC_ARM_METADATA" release-assets/latest-mac.yml
          fi

          WIN_METADATA="$(find artifacts -type f -name 'latest.yml' | head -n 1)"
          if [[ -n "$WIN_METADATA" ]]; then
            cp "$WIN_METADATA" release-assets/latest.yml
          fi

          validate_metadata() {
            local file_path="$1"
            local label="$2"

            local has_valid_files_array
            has_valid_files_array="$(yq e '(.files | type) == "!!seq" and (.files | length) > 0' "$file_path")"
            if [[ "$has_valid_files_array" != "true" ]]; then
              echo "${label}: missing or invalid files array"
              exit 1
            fi

            local invalid_entries
            invalid_entries="$(yq e '[.files[] | select((.url == null or .url == "") or (.sha512 == null or .sha512 == ""))] | length' "$file_path")"
            if [[ "$invalid_entries" != "0" ]]; then
              echo "${label}: files entries must include non-empty url and sha512"
              exit 1
            fi
          }

          if [[ -f release-assets/latest-mac.yml ]]; then
            validate_metadata "release-assets/latest-mac.yml" "latest-mac.yml"
          fi
          if [[ -f release-assets/latest.yml ]]; then
            validate_metadata "release-assets/latest.yml" "latest.yml"
          fi

          if [[ "$CHANNEL" != "latest" ]]; then
            if [[ -f release-assets/latest-mac.yml ]]; then
              cp release-assets/latest-mac.yml "release-assets/${CHANNEL}-mac.yml"
            fi
            if [[ -f release-assets/latest.yml ]]; then
              cp release-assets/latest.yml "release-assets/${CHANNEL}.yml"
            fi
          fi

      - name: List prepared release assets
        run: |
          echo "=== Release assets ==="
          find release-assets -type f | sort

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Amical Desktop v${{ steps.package_version.outputs.version }}
          body: |
            ## Amical Desktop v${{ steps.package_version.outputs.version }}

            ### What's New
            - Please update this section with actual changes

            ### Downloads

            #### macOS
            - **Apple Silicon (M1/M2/M3)**: Download the DMG or ZIP file for arm64
            - **Intel**: Download the DMG or ZIP file for x64

            #### Windows
            - **Windows (x64)**: Download and run the NSIS .exe installer

            ### Installation

            **macOS**: 
            - **DMG**: Download and open the DMG file, then drag Amical to your Applications folder
            - **ZIP**: Download and extract the ZIP file, then drag Amical to your Applications folder

            **Windows**:
            - Download and run the .exe installer
            - Follow the installation wizard
            - The app will be installed under your user profile with uninstall support

            The ZIP files are primarily for automatic updates. We recommend using the DMG files for initial installation on macOS.
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
